var runningAutoSave=!1,PageNewForm=new Vue({el:"#PageNewForm-root",data:{debug:DEBUGMODE,loader:!0,editMode:!1,page_id:null,user:null,form:new VueForm({title:{value:null,required:!0,type:"username",maxLength:120,minLength:5,customPattern:/[a-zA-Z0-9,#.-\s]+/},subtitle:{value:null,required:!1,type:"username",maxLength:120,minLength:5,customPattern:/[a-zA-Z0-9,#.-\s]+/}}),status:!1,path:"",content:"Content of the page",visibility:1,publishondate:!0,datepublish:"",timepublish:"",template:"default",layout:"default",categorie_id:"0",subcategorie_id:"0",page_type_id:"1",layouts:[],mainImage:[],templates:[],pageTypes:[],categories:[],subcategories:[],page_data:{title:""},customMetas:[],metas:[{name:"author",content:new User(JSON.parse(localStorage.getItem("userdata"))).get_fullname()},{name:"keywords",content:""},{name:"description",content:""},{name:"ROBOTS",content:"NOODP"},{name:"GOOGLEBOT",content:"INDEX, FOLLOW"},{property:"og:title",content:""},{property:"og:description",content:""},{property:"og:site_name",content:SITE_TITLE},{property:"og:url",content:""},{property:"og:image",content:""},{property:"og:type",content:"article"},{property:"twitter:card",content:"summary_large_image"},{property:"twitter:title",content:""},{property:"twitter:description",content:""},{property:"twitter:image",content:""}],fullView:!1},mixins:[mixins],computed:{btnEnable:function(){let e=!!this.form.fields.title.value&&!!this.path||!1;return e&&this.autoSave(),e},getDateTimePublish:function(){return this.datepublish&&this.timepublish?this.datepublish+" "+this.timepublish+":00":null},preview_link:function(){return this.page_id?BASEURL+"admin/paginas/preview?page_id="+this.page_id:""},getMainImagenPath(){return this.mainImage.length>0?this.mainImage[0].file_id:null},getPagePath(){let e=this.getPathSegments().filter((e,t)=>e.length>0);return e=e.map((e,t)=>this.string_to_slug(e)),e.join("/")}},watch:{"form.fields.title.value":function(e){this.setPath(e)},publishondate:function(e){e&&(this.datepublish="",this.timepublish="")}},filters:{capitalize:function(e){return e?(e=e.toString()).charAt(0).toUpperCase()+e.slice(1):""}},methods:{toggleFullView:function(){this.fullView=!this.fullView},expandView:function(){this.fullView=!this.fullView},addCustomMeta(){this.customMetas.push({name:"",content:""})},removeMeta(e,t=!0){t?this.customMetas.splice(e,1):this.metas.splice(e,1)},setMetaContent(e,t,a){void 0===a?this.metas=this.metas.map(a=>(a.property!=t&&a.name!=t||(a.content=e),a)):this.metas[a].content=e},getPathSegments(){let e="";1==this.page_type_id?e="":(e=this.getSelectedPageType(),e=e.length?e[0].page_type_name:"");let t=this.getSelectedCategorie();t=t[0]?t[0].name:"",t=""==e?"":t;let a=this.getSelectedSubCategorie();return a=a[0]?a[0].name:"",a=""==e?"":a,[e,t,a,this.path]},onChangeTitle(e){this.page_data.title=e,this.setMetaContent(e,"og:title"),this.setMetaContent(e,"twitter:title"),this.setMetaContent(e,"keywords")},autoSave(){this.status||runningAutoSave||(runningAutoSave=!0,setTimeout(()=>{this.runSaveData(),this.debug&&console.log("running autosave..."),runningAutoSave=!1},3e3))},removeImage(e){this.mainImage.length>0&&this.mainImage.splice(e,1),0==this.mainImage.length&&(this.mainImage=[])},getFileImagenPath(e){return BASEURL+e.file_path.substr(2)+this.getFileImagenName(e)},getFileImagenName:e=>e.file_name+"."+e.file_type,setPath(e){let t=this.string_to_slug(e);this.path=t,this.setMetaContent(BASEURL+t,"og:url")},validateField(e){let t=UserNewForm;if(!t.form.validateField(e))return t.form.fields[e].valid;t.serverValidation(e)},validateForm(){this.form.validate();return this.publishondate||this.datepublish||this.timepublish||(error=!1),0==this.form.errors.length&&!0},save(){this.validateForm()?(this.loader=!0,this.runSaveData((function(e){if(1==e.data.status)var t='<span>Page saved </span><a target="_blank" href="'+BASEURL+e.data.path+'" class="btn-flat toast-action">View in site</a>';else t='<span>Draf saved </span><a target="_blank" href="'+BASEURL+"admin/paginas/preview?page_id="+e.data.page_id+'" class="btn-flat toast-action">Preview</a>';M.toast({html:t})}))):M.toast({html:"Verifique todos los campos del formulario"})},runSaveData(e){var t=this,a=BASEURL+"api/v1/pages";$.ajax({type:"POST",url:a,data:t.getData(),dataType:"json",success:function(i){t.debug&&console.log(a,i),setTimeout(()=>{t.loader=!1},1500),200==i.code?(t.editMode=!0,t.page_id=i.data.page_id,"function"==typeof e&&e(i)):(M.toast({html:i.error_message}),t.loader=!1)},error:function(e){t.loader=!1,M.toast({html:"OcurriÃ³ un error inesperado"}),console.error(error)}})},getData:function(){return{title:this.form.fields.title.value||"",subtitle:this.form.fields.subtitle.value||"",path:this.getPagePath||"",page_type_id:this.page_type_id||1,status:this.status?1:2,content:wp.data.select("core/editor").getEditedPostContent()||"Content of the page...",page_id:this.page_id||null,publishondate:this.publishondate,date_publish:this.getDateTimePublish,visibility:this.visibility,template:this.template||"default",layout:this.layout||"default",categorie_id:this.categorie_id||0,subcategorie_id:this.subcategorie_id||0,mainImage:this.getMainImagenPath,page_data:{tags:this.getPageTags(),title:this.page_data.title,footer_includes:this.page_data.footer_includes,headers_includes:this.page_data.headers_includes,meta:[...this.metas,...this.customMetas]}}},getPageTags(){let e=[];return M.Chips.getInstance(document.getElementById("pageTags")).chipsData.forEach(t=>{e.push(t.tag)}),e},getUrl(){return BASEURL+this.path},checkEditMode(){var e=document.getElementById("page_id").value,t=document.getElementById("editMode").value;if(e&&"edit"==t){var a=this;a.editMode=!0;var i=BASEURL+"api/v1/pages/editpageinfo/"+e;fetch(i).then(e=>e.json()).then(e=>{a.loader=!1,a.debug&&console.log(i,e),200==e.code&&(a.form.fields.title.value=e.data.page.title,a.form.fields.subtitle.value=e.data.page.subtitle,a.page_id=e.data.page.page_id,a.status="1"==e.data.page.status,a.path=e.data.page.path,a.visibility=e.data.page.visibility,a.publishondate=!!e.data.page.date_publish,a.template=e.data.page.template,a.categorie_id=e.data.page.categorie_id||0,a.subcategories_id=e.data.page.subcategories_id||0,a.pageTypes=e.data.page_types,a.page_type_id=e.data.page.page_type_id,a.page_data=e.data.page.page_data,a.user=new User(e.data.page.user),a.content=e.data.page,a.setEditorContent(e.data.page))}).catch(e=>{a.loader=!1})}},initPlugins(){setTimeout(()=>{var e=document.querySelectorAll(".datepicker");M.Datepicker.init(e,{format:"yyyy-mm-dd",onClose:function(){PageNewForm.datepublish=document.getElementById("datepublish").value}});e=document.querySelectorAll(".timepicker");M.Timepicker.init(e,{twelveHour:!1,defaultTime:"now",onCloseEnd:function(){PageNewForm.timepublish=document.getElementById("timepublish").value}})},1e3)},initSelects(){setTimeout(()=>{var e=document.querySelectorAll("select");M.FormSelect.init(e,{})},1e3)},setEditorContent:function(e){console.log({page:e});let t={id:1,content:{raw:e.content,rendered:e.content},date:"2020-11-24T21:22:54.913Z",date_gmt:"2020-11-24T21:22:54.913Z",title:{raw:"Preview page",rendered:"Preview page"},excerpt:{raw:"",rendered:""},status:"draft",revisions:{count:0,last_id:0},parent:0,theme_style:!0,type:"page",link:"http://localhost:8000/preview",categories:[],featured_media:0,permalink_template:"http://localhost:8000/preview",preview_link:"http://localhost:8000/preview",_links:{"wp:action-assign-categories":[],"wp:action-create-categories":[]}};localStorage.setItem("g-editor-page",JSON.stringify(t))}},mounted:function(){this.$nextTick((function(){this.debug&&console.log("mounted PageNewForm"),this.initPlugins(),this.checkEditMode()}))}});