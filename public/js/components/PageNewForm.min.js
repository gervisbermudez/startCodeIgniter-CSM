var PageNewForm=new Vue({el:"#root",data:{debug:!0,loader:!0,editMode:!1,page_id:null,form:new VueForm({title:{value:null,required:!0,type:"username",maxLength:120,minLength:5,customPattern:/[a-zA-Z0-9,#.-\s]+/},subtitle:{value:null,required:!1,type:"username",maxLength:120,minLength:5,customPattern:/[a-zA-Z0-9,#.-\s]+/}}),status:!1,path:"",content:"",visibility:1,publishondate:!0,datepublish:"",timepublish:"",template:"default",templates:[],layout:"default",layouts:[],categorie:"0",subcategorie:"0",pageTypes:[],categories:[],subcategories:[],pageType:{page_type_id:"1",page_type_name:"page"}},computed:{btnEnable:function(){let e=!!this.form.fields.title.value&&!!this.path&&!!this.content||!1;return e&&this.autoSave(),e},getDateTimePublish:function(){return this.datepublish&&this.timepublish?this.datepublish+" "+this.timepublish+":00":null},preview_link:function(){return this.page_id?BASEURL+"admin/paginas/preview?page_id="+this.page_id:""}},watch:{"form.fields.title.value":function(e){this.setPath(e)},publishondate:function(e){e&&(this.datepublish="",this.timepublish="")},pageType:function(e,t){if(this.debug&&console.log(e,t),-1!=this.path.indexOf(t.page_type_name+"/")){let a=e.page_type_name+"/";"1"==e.page_type_id&&(a=""),this.path=this.path.replace(t.page_type_name+"/",a)}this.setPath(this.path)}},filters:{capitalize:function(e){return e?(e=e.toString()).charAt(0).toUpperCase()+e.slice(1):""}},methods:{autoSave(){this.status||(this.runSaveData(),this.debug&&console.log("running autosave..."))},setPath(e){let t=this.pageType&&"1"!=this.pageType.page_type_id;t&&-1!=e.indexOf(this.pageType.page_type_name+"/")&&(e=e.replace(this.pageType.page_type_name+"/",""));let a=this.string_to_slug(e);this.path=t?this.pageType.page_type_name+"/"+a:a},string_to_slug:function(e){if(0==e.length)return"";e=(e=e.replace(/^\s+|\s+$/g,"")).toLowerCase();for(var t="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",a=0,i=t.length;a<i;a++)e=e.replace(new RegExp(t.charAt(a),"g"),"aaaaeeeeiiiioooouuuunc------".charAt(a));return e=e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},validateField(e){let t=UserNewForm;if(!t.form.validateField(e))return t.form.fields[e].valid;t.serverValidation(e)},validateForm(){this.form.validate();return this.publishondate||this.datepublish||this.timepublish||(error=!1),0==this.form.errors.length&&!0},save(){this.validateForm()?(this.loader=!0,this.runSaveData((function(e){if(1==e.data.status)var t='<span>Page saved </span><a target="_blank" href="'+BASEURL+e.data.path+'" class="btn-flat toast-action">View in site</a>';else t='<span>Draf saved </span><a target="_blank" href="'+BASEURL+"admin/paginas/preview?page_id="+e.data.page_id+'" class="btn-flat toast-action">Preview</a>';M.toast({html:t})}))):M.toast({html:"Verifique todos los campos del formulario"})},runSaveData(e){var t=this;$.ajax({type:"POST",url:BASEURL+"admin/paginas/ajax_save_page",data:t.getData(),dataType:"json",success:function(a){setTimeout(()=>{t.loader=!1},1500),200==a.code?(t.editMode=!0,t.page_id=a.data.page_id,"function"==typeof e&&e(a)):(M.toast({html:a.responseJSON.error_message}),t.loader=!1)},error:function(e){M.toast({html:e.responseJSON.error_message}),t.loader=!1}})},getData:function(){return{title:this.form.fields.title.value||"",subtitle:this.form.fields.subtitle.value||"",path:this.path||"",type:this.pageType.page_type_id||1,status:this.status?1:2,content:this.content||"",page_id:this.page_id||null,publishondate:this.publishondate,date_publish:this.getDateTimePublish,visibility:this.visibility,template:this.template||"default",layout:this.layout||"default",categorie:this.categorie||0,subcategorie:this.subcategorie||0}},getTemplates(){var e=this;$.ajax({type:"POST",url:BASEURL+"admin/paginas/ajax_get_templates",data:{},dataType:"json",success:function(t){e.debug&&console.log("ajax_get_templates: ",t),200==t.code&&(e.templates=t.data.templates.map((function(e){let t=e.split(".")[0];return"template"==t?"default":t})),e.layouts=t.data.layouts.map((function(e){let t=e.split(".")[0];return"site"==t?"default":t})))},error:function(t){e.debug&&console.log(t),e.loader=!1}})},serverValidation(e){var t=this;$.ajax({type:"POST",url:BASEURL+"admin/usuarios/ajax_check_field",data:{field:e,value:t.form.fields[e].value},dataType:"json",success:function(a){a.code&&(t.form.fields[e].valid=a.data,a.data?t.form.markFieldAsValid(e):t.form.fields[e].errorText="The "+e+" is already registered",t.$forceUpdate())}})},getPageTypes(){var e=this;$.ajax({type:"POST",url:BASEURL+"admin/paginas/ajax_get_page_types",data:{},dataType:"json",success:function(t){e.debug&&console.log("ajax_get_page_types: ",t),200==t.code&&(e.pageTypes=t.data)},error:function(t){e.debug&&console.log(t),e.loader=!1}})},getCategories(){var e=this;$.ajax({type:"POST",url:BASEURL+"admin/categorias/ajax_get_categorie_type",data:{categorie_type:"page"},dataType:"json",success:function(t){e.debug&&console.log("ajax_get_categorie_type: ",t),200==t.code&&(PageNewForm.categories=t.data)},error:function(t){e.debug&&console.log(t),e.loader=!1}})},getSubCategories(){var e=this;$.ajax({type:"POST",url:BASEURL+"admin/categorias/ajax_get_subcategorie_type",data:{categorie_type:"page",parent_id:e.categorie},dataType:"json",success:function(t){console.log("ajax_get_subcategorie_type: ",t),200==t.code&&(e.subcategories=t.data,PageNewForm.initSelects())},error:function(t){e.debug&&console.log(t),e.loader=!1}})},checkEditMode(){var e=document.getElementById("page_id").value,t=document.getElementById("editMode").value;if(e&&"edit"==t){var a=this;a.editMode=!0,$.ajax({type:"POST",url:BASEURL+"admin/paginas/ajax_get_page",data:{page_id:e},dataType:"json",success:function(e){a.loader=!1,a.debug&&console.log("ajax_get_page: ",e),200==e.code&&(a.form.fields.title.value=e.data.title,a.form.fields.subtitle.value=e.data.subtitle,a.page_id=e.data.page_id,a.status="1"==e.data.status,a.path=e.data.path,a.visibility=e.data.visibility,a.publishondate=!!e.data.date_publish,a.template=e.data.template,a.categorie=e.data.categorie||0,a.subcategories=e.data.subcategories||0,setTimeout(()=>{tinymce.editors.id_cazary.setContent(e.data.content),a.content=e.data.content},2e3)),setTimeout(()=>{M.updateTextFields()},1e3)},error:function(e){M.toast({html:response.responseJSON.error_message}),a.loader=!1}})}},initPlugins(){tinymce.init({selector:"textarea",plugins:["link table code"],setup:function(e){e.on("Change",(function(e){PageNewForm.content=tinymce.editors.id_cazary.getContent()}))}}),setTimeout(()=>{var e=document.querySelectorAll(".datepicker");M.Datepicker.init(e,{format:"yyyy-mm-dd",onClose:function(){PageNewForm.datepublish=document.getElementById("datepublish").value}});e=document.querySelectorAll(".timepicker");M.Timepicker.init(e,{twelveHour:!1,defaultTime:"now",onCloseEnd:function(){PageNewForm.timepublish=document.getElementById("timepublish").value}}),this.initSelects()},1e3)},initSelects(){setTimeout(()=>{var e=document.querySelectorAll("select");M.FormSelect.init(e,{})},1e3)}},mounted:function(){this.$nextTick((function(){this.debug&&console.log("mounted PageNewForm"),this.loader=!1,this.getPageTypes(),this.checkEditMode(),this.getCategories(),this.getTemplates(),this.initPlugins()}))}});