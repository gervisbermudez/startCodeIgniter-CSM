var EventNewForm=new Vue({el:"#root",data:{debug:DEBUGMODE,loader:!0,editMode:!1,event_id:null,name:"",subtitle:"",address:"",content:"",status:!1,visibility:!0,date_publish:"",date_create:"",date_update:"",type:"event",categorie_id:"0",categories:[],categories:[],user_id:null,user:null,mainImage:[],publishondate:!0,datepublish:"",timepublish:""},computed:{btnEnable:function(){let e=!!this.name||!1;return e},getDateTimePublish:function(){return this.datepublish&&this.timepublish?this.datepublish+" "+this.timepublish+":00":null},getMainImagenPath(){return this.mainImage.length>0?this.mainImage[0].file_id:null}},filters:{capitalize:function(e){return e?(e=e.toString()).charAt(0).toUpperCase()+e.slice(1):""}},methods:{removeImage(e){this.mainImage.length>0&&this.mainImage.splice(e,1),0==this.mainImage.length&&(this.mainImage=[])},getFileImagenPath(e){return BASEURL+e.file_path.substr(2)+this.getFileImagenName(e)},getFileImagenName:e=>e.file_name+"."+e.file_type,copyCallcack(e){let t=e[0];t=new ExplorerFile(t),this.mainImage.push(t),M.Modal.getInstance($("#fileUploader")).close()},autoSave(){this.status||(this.runSaveData(),this.debug&&console.log("running autosave..."))},validateField(e){let t=UserNewForm;if(!t.form.validateField(e))return t.form.fields[e].valid;t.serverValidation(e)},validateForm(){return this.name&&this.content},save(){this.validateForm()?(this.loader=!0,this.runSaveData(e=>{M.toast({html:"<span>Event saved </span>"})})):M.toast({html:"Verifique todos los campos del formulario"})},runSaveData(e){this.debug&&console.log(getFuncName()+" fired");var t=this,a=BASEURL+"api/v1/events";$.ajax({type:"POST",url:a,data:t.getData(),dataType:"json",success:function(i){t.debug&&console.log(a,i),setTimeout(()=>{t.loader=!1},1500),200==i.code?(t.editMode=!0,t.event_id=i.data.event_id,"function"==typeof e&&e(i)):(M.toast({html:i.error_message}),t.loader=!1)},error:function(e){t.loader=!1,M.toast({html:"OcurriÃ³ un error inesperado"}),console.error(e)}})},getData:function(){return{event_id:this.event_id||"",name:this.name||"",subtitle:this.subtitle||"",content:this.content||"",address:this.address||"",mainImage:this.getMainImagenPath,categorie_id:this.categorie_id||0,status:this.status?1:0,visibility:this.visibility?1:0,date_publish:this.getDateTimePublish,date_create:this.date_create,date_update:this.date_update}},getSelectedCategorie(){return this.categories.filter((e,t)=>this.event_id==e.event_id)},serverValidation(e){var t=this,a=BASEURL+"admin/usuarios/ajax_check_field";$.ajax({type:"POST",url:a,data:{field:e,value:t.form.fields[e].value},dataType:"json",success:function(i){t.debug&&console.log(a,i),i.code&&(t.form.fields[e].valid=i.data,i.data?t.form.markFieldAsValid(e):t.form.fields[e].errorText="The "+e+" is already registered",t.$forceUpdate())}})},getCategories(){this.debug&&console.log(getFuncName()+" fired");var e=this,t=BASEURL+"api/v1/categorie/type/"+e.type;fetch(t).then(e=>e.json()).then(a=>{e.loader=!1,e.debug&&console.log(t,a),200==a.code&&(e.categories=a.data,this.initSelects())}).catch(t=>{e.debug&&console.log(t),e.loader=!1})},checkEditMode(){this.debug&&console.log(getFuncName()+" fired");var e=this;if(event_id&&"edit"==editMode){e.editMode=!0;var t=BASEURL+"api/v1/events/"+event_id;fetch(t).then(e=>e.json()).then(a=>{e.loader=!1,e.debug&&console.log(t,a),200==a.code&&(e.event_id=a.data.event_id,e.date_create=a.data.date_create,e.date_publish=a.data.date_publish,e.date_update=a.data.date_update,e.name=a.data.name,e.subtitle=a.data.subtitle,e.categorie_id=a.data.categorie_id,e.status=a.data.status,e.visibility=a.data.visibility,e.address=a.data.address,e.type=a.data.type,e.user_id=a.data.user_id,e.parent=a.data.parent,e.subcategories=a.data.subcategories,e.user=new User(a.data.user),e.content=a.data.content,a.data.mainImage&&e.mainImage.push(new ExplorerFile(a.data.mainImage)),setTimeout(()=>{tinymce.editors.id_cazary.setContent(a.data.content)},5e3))}).catch(t=>{M.toast({html:t.error_message}),e.loader=!1})}else e.loader=!1},initSelects(){setTimeout(()=>{var e=document.querySelectorAll("select");M.FormSelect.init(e,{})},1e3)},initPlugins(){this.debug&&console.log(getFuncName()+" fired");var e=document.querySelectorAll(".datepicker");M.Datepicker.init(e,{format:"yyyy-mm-dd",onClose:function(){alert("Datepicker"),EventNewForm.datepublish=document.getElementById("datepublish").value}});e=document.querySelectorAll(".timepicker");M.Timepicker.init(e,{twelveHour:!1,defaultTime:"now",onCloseEnd:function(){alert("Timepicker"),EventNewForm.timepublish=document.getElementById("timepublish").value}}),tinymce.init({selector:"textarea",plugins:["link table code"],setup:e=>{e.on("Change",e=>{this.content=tinymce.editors.id_cazary.getContent()})}})}},mounted:function(){this.$nextTick((function(){this.debug&&console.log("mounted EventNewForm"),this.getCategories(),this.initPlugins(),this.checkEditMode()}))}});