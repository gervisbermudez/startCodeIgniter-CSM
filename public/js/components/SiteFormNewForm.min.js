var SiteFormNewForm=new Vue({el:"#root",data:{debug:DEBUGMODE,loader:!0,editMode:!1,siteform_id:null,form:{},name:"New Form",status:!1,date_publish:"",date_create:"",date_update:"",template:"",siteform_items:[],items_types:["text","textarea","select","button","checkbox","color","date","datetime-local","email","file","hidden","image","month","number","password","radio","range","reset","search","submit","tel","time","url","week"],templates:[],positions:{},position:"",user_id:null,user:null,realOrder:{},group:{},targetItem:{}},mixins:[mixins],computed:{btnEnable:function(){return!(!this.name||!this.template)}},filters:{capitalize:function(e){return e?(e=e.toString()).charAt(0).toUpperCase()+e.slice(1):""}},methods:{autoSave(){this.status||(this.runSaveData(),this.debug&&console.log("running autosave..."))},validateField(e){let t=UserNewForm;if(!t.form.validateField(e))return t.form.fields[e].valid;t.serverValidation(e)},validateForm(){this.form.validate();return 0==this.form.errors.length&&!0},save(){this.loader=!0,this.runSaveData(e=>{M.toast({html:"<span>Siteform saved </span>"}),this.setCollapsibleEvent()})},runSaveData(e){var t=this,i=BASEURL+"api/v1/siteforms";$.ajax({type:"POST",url:i,data:t.getData(),dataType:"json",success:function(s){t.debug&&console.log(i,s),setTimeout(()=>{t.loader=!1},1500),200==s.code?(t.editMode=!0,t.siteforms_id=s.data.siteform_id,"function"==typeof e&&e(s)):(M.toast({html:s.responseJSON.error_message}),t.loader=!1)},error:function(e){M.toast({html:e.responseJSON.error_message}),t.loader=!1}})},getData:function(){return{siteform_id:this.siteform_id||"",name:this.name||"",template:this.template||"",status:this.status?1:0,siteform_items:this.siteform_items.map(e=>({...e,properties:JSON.stringify(e.properties),data:JSON.stringify(e.data)}))}},getSelectedCategorie(){return this.categories.filter((e,t)=>this.siteform_id==e.siteform_id)},getTemplates(){var e=BASEURL+"api/v1/siteforms/templates/";fetch(e).then(e=>e.json()).then(t=>{this.debug&&console.log(e,t),200==t.code&&(this.templates=t.data.map(e=>e.split(".")[0]),this.initPlugins(),this.setCollapsibleEvent())}).catch(e=>{this.debug&&console.log(e),this.loader=!1})},checkEditMode(){var e=this;if(siteform_id&&"edit"==editMode){e.editMode=!0;var t=BASEURL+"api/v1/siteforms/"+siteform_id;fetch(t).then(e=>e.json()).then(i=>{e.loader=!1,e.debug&&console.log(t,i),200==i.code&&(e.siteform_id=i.data.siteform_id,e.name=i.data.name,e.template=i.data.template,e.position=i.data.position,e.date_create=i.data.date_create,e.date_publish=i.data.date_publish,e.status=i.data.status,e.user_id=i.data.user_id,e.siteform_items=i.data.siteform_items.map(e=>({...e,properties:JSON.stringify(e.properties),data:JSON.stringify(e.data)})),e.user=new User(i.data.user)),this.initPlugins()}).catch(t=>{M.toast({html:t.responseJSON.error_message}),e.loader=!1})}else e.loader=!1,this.initPlugins()},addItem(){this.siteform_items.push({siteform_item_id:"",siteform_id:this.siteform_id,siteform_item_parent_id:"0",item_type:"text",item_name:"Field-"+this.makeid(3).toLocaleLowerCase(),item_label:"field Text",item_title:"Field Title",item_placeholder:"Field Title",item_placeholder:"Field Title",item_class:"",date_publish:"",date_create:"",date_update:"",status:"1",order:"1",data:"{}",properties:"{}"}),this.setCollapsibleEvent()},removeItem(e,t){t.splice(e,1)},openPageSelector(e){this.targetItem=e,M.Modal.getInstance($(".modal")).open()},copyCallcack(e){M.Modal.getInstance($(".modal")).close(),this.targetItem.item_link="/"+e[0].path,this.targetItem.item_name=this.string_to_slug(e[0].title)+"-"+this.makeid(3).toLocaleLowerCase(),this.targetItem.item_label=e[0].title,this.targetItem.item_title=e[0].title,this.targetItem.model_id=e[0].page_id,this.targetItem.model="page"},initPlugins(){setTimeout(()=>{var e=document.querySelectorAll("select");M.FormSelect.init(e,{}),this.group=$(".default").sortable({delay:500,handle:"i.icon-move",onDrop:(e,t,i)=>{this.setRealOrder(),this.setCollapsibleEvent(),i(e,t)}})},3e3)},setRealOrder(){var e=this.group.sortable("serialize").get();console.log(e),e[0].forEach((e,t)=>{this.siteform_items=this.siteform_items.map(i=>(i.item_name==e.name&&(i.order=t),i))})},getMenuItemsData(e){return e.map((e,t)=>(e.subitems&&e.subitems[0].length>0&&(e.subitems=this.getMenuItemsData(e.subitems[0])),{...this.getMenuItemByName(e.name,this.siteform_items),...e,order:t}))},getMenuItemByName(e,t){var i=null;for(let s=0;s<t.length;s++){const a=t[s];if(a.item_name==e){i=a;break}if(a.subitems.length>0){let t=this.getMenuItemByName(e,a.subitems);if(t&&t.item_name==e){i=t;break}}}return i},isEditable:e=>!(e.model&&e.model_id),makeEditable(e){e.model=null,e.model_id=null,e.model_object=null},removeCollapsideEvent(){$(".menuitem .collapsible-header").off()},setCollapsibleEvent(){this.removeCollapsideEvent(),setTimeout(()=>{$(".menuitem .collapsible-header").click((function(e){e.preventDefault(),$(this).parent().toggleClass("active")}))},3e3)}},mounted:function(){this.$nextTick((function(){this.debug&&console.log("mounted MenuNewForm"),this.getTemplates(),this.checkEditMode()}))}});