var MenuNewForm=new Vue({el:"#root",data:{debug:DEBUGMODE,loader:!0,editMode:!1,menu_id:null,form:{},name:"",status:!1,date_publish:"",date_create:"",date_update:"",template:"",menu_items:[],templates:[],categories_type:["page","formulario","video","foto","evento","contenido"],user_id:null,user:null,realOrder:{},group:{},targetItem:{}},mixins:[mixins],computed:{btnEnable:function(){return!!(this.name&&this.template&&this.menu_items.length>0)}},filters:{capitalize:function(e){return e?(e=e.toString()).charAt(0).toUpperCase()+e.slice(1):""}},methods:{autoSave(){this.status||(this.runSaveData(),this.debug&&console.log("running autosave..."))},validateField(e){let t=UserNewForm;if(!t.form.validateField(e))return t.form.fields[e].valid;t.serverValidation(e)},validateForm(){this.form.validate();return 0==this.form.errors.length&&!0},save(){this.loader=!0,this.runSaveData(e=>{M.toast({html:"<span>Menu saved </span>"}),this.setCollapsibleEvent()})},runSaveData(e){var t=this,a=BASEURL+"api/v1/menus";$.ajax({type:"POST",url:a,data:t.getData(),dataType:"json",success:function(i){t.debug&&console.log(a,i),setTimeout(()=>{t.loader=!1},1500),200==i.code?(t.editMode=!0,t.menu_id=i.data.menu_id,t.menu_items=i.data.menu_items,"function"==typeof e&&e(i)):(M.toast({html:i.responseJSON.error_message}),t.loader=!1)},error:function(e){M.toast({html:e.responseJSON.error_message}),t.loader=!1}})},getData:function(){return this.setRealOrder(),{menu_id:this.menu_id||"",name:this.name||"",template:this.template||"",status:this.status?1:0,menu_items:this.realOrder}},getSelectedCategorie(){return this.categories.filter((e,t)=>this.menu_id==e.menu_id)},getTemplates(){var e=BASEURL+"api/v1/menus/templates/";fetch(e).then(e=>e.json()).then(t=>{this.loader=!1,this.debug&&console.log(e,t),200==t.code&&(this.templates=t.data.map(e=>e.split(".")[0]),this.initPlugins(),this.setCollapsibleEvent())}).catch(e=>{this.debug&&console.log(e),this.loader=!1})},checkEditMode(){var e=this;if(menu_id&&"edit"==editMode){e.editMode=!0;var t=BASEURL+"api/v1/menus/"+menu_id;fetch(t).then(e=>e.json()).then(a=>{e.loader=!1,e.debug&&console.log(t,a),200==a.code&&(e.menu_id=a.data.menu_id,e.name=a.data.name,e.template=a.data.template,e.date_create=a.data.date_create,e.date_publish=a.data.date_publish,e.status=a.data.status,e.user_id=a.data.user_id,e.menu_items=a.data.menu_items,e.user=new User(a.data.user)),this.initPlugins()}).catch(t=>{M.toast({html:t.responseJSON.error_message}),e.loader=!1})}else e.loader=!1},addItem(){this.menu_items.push({menu_item_id:"",menu_id:this.menu_id,menu_item_parent_id:"0",item_type:"static_link",item_name:"link-"+this.makeid(3).toLocaleLowerCase(),item_label:"Link Text",item_link:"#!",item_title:"Link Title",item_target:"_self",date_publish:"",date_create:"",date_update:"",status:"1",subitems:[]}),this.setCollapsibleEvent()},removeItem(e,t){t.splice(e,1)},openPageSelector(e){this.targetItem=e,M.Modal.getInstance($(".modal")).open()},copyCallcack(e){M.Modal.getInstance($(".modal")).close(),this.targetItem.item_link="/"+e[0].path,this.targetItem.item_name=this.string_to_slug(e[0].title)+"-"+this.makeid(3).toLocaleLowerCase(),this.targetItem.item_label=e[0].title,this.targetItem.item_title=e[0].title,this.targetItem.model_id=e[0].page_id,this.targetItem.model="page"},initPlugins(){setTimeout(()=>{var e=document.querySelectorAll("select");M.FormSelect.init(e,{}),this.group=$(".default").sortable({delay:500,handle:"i.icon-move",onDrop:(e,t,a)=>{this.setRealOrder(),this.setCollapsibleEvent(),a(e,t)}})},3e3)},setRealOrder(){var e=this.group.sortable("serialize").get(),t=(t=JSON.stringify(e)).replace(/children/g,"subitems");if(e=JSON.parse(t)){let t=this.getMenuItemsData(e[0]);this.realOrder=t}},getMenuItemsData(e){return e.map((e,t)=>(e.subitems&&e.subitems[0].length>0&&(e.subitems=this.getMenuItemsData(e.subitems[0])),{...this.getMenuItemByName(e.name,this.menu_items),...e,order:t}))},getMenuItemByName(e,t){var a=null;for(let i=0;i<t.length;i++){const s=t[i];if(s.item_name==e){a=s;break}if(s.subitems.length>0){let t=this.getMenuItemByName(e,s.subitems);if(t&&t.item_name==e){a=t;break}}}return a},isEditable:e=>!(e.model&&e.model_id),makeEditable(e){e.model=null,e.model_id=null,e.model_object=null},removeCollapsideEvent(){$(".menuitem .collapsible-header").off()},setCollapsibleEvent(){this.removeCollapsideEvent(),setTimeout(()=>{$(".menuitem .collapsible-header").click((function(e){e.preventDefault(),$(this).parent().toggleClass("active")}))},3e3)}},mounted:function(){this.$nextTick((function(){this.debug&&console.log("mounted MenuNewForm"),this.getTemplates(),this.checkEditMode()}))}});