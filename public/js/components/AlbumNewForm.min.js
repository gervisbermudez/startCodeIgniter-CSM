var AlbumNewForm=new Vue({el:"#root",data:{debug:DEBUGMODE,loader:!0,editMode:!1,album_id:null,items:[],form:new VueForm({name:{value:null,required:!0,type:"address",maxLength:250,minLength:1,customPattern:/[a-zA-Z0-9,#.-\s]+/}}),description:"",status:!1,date_publish:"",date_create:"",date_update:"",user_id:null,user:null},mixins:[mixins],computed:{btnEnable:function(){let e=!!this.form.fields.name.value&&!!this.description||!1;return e},preselected:function(){return this.items.map(e=>e.file)}},methods:{getPageImagePath:e=>e.file.get_full_file_path()?e.file.get_full_file_path():BASEURL+"public/img/default.jpg",copyCallcack(e){M.Modal.getInstance($(".modal")).close(),this.items=[...e.map(e=>{let t={album_id:"",album_item_id:"",date_create:"",date_update:"",description:"",file:new ExplorerFile(e),file_id:e.file_id,name:"",status:"1"};return this.items.forEach(a=>{a.file.file_id==e.file_id&&(t=a)}),t})],setTimeout(()=>{var e=document.querySelectorAll(".tooltipped");M.Tooltip.init(e,{});e=document.querySelectorAll(".dropdown-trigger");M.Dropdown.init(e,{});e=document.querySelectorAll(".materialboxed");M.Materialbox.init(e,{})},3e3)},autoSave(){this.status||(this.runSaveData(e=>{console.log(e)}),this.debug&&console.log("running autosave..."))},validateField(e){let t=UserNewForm;if(!t.form.validateField(e))return t.form.fields[e].valid;t.serverValidation(e)},validateForm(){this.form.validate();return 0==this.form.errors.length&&!0},save(){var e=this;e.validateForm()?(this.loader=!0,this.runSaveData(t=>{var a=`<span>Album saved </span><a href="${BASEURL+"admin/galeria/items/"+e.album_id}" class="btn-flat toast-action">View</a>`;M.toast({html:a})})):M.toast({html:"Verifique todos los campos del formulario"})},removeItemImage(e){e=e;var t=this;let a=this.items[e];a.album_item_id?$.ajax({type:"GET",url:BASEURL+"api/v1/albumes/delete_album_item/"+a.album_item_id,data:{},dataType:"json",success:function(a){200==a.code&&(M.toast({html:"Imagen quitada"}),t.items.splice(e,1))}}):this.items.splice(e,1)},runSaveData(e){var t=this,a=BASEURL+"api/v1/albumes";$.ajax({type:"POST",url:a,data:t.getData(),dataType:"json",success:function(i){t.debug&&console.log(a,i),setTimeout(()=>{t.loader=!1},1500),200==i.code?(t.editMode=!0,t.album_id=i.data.album_id,"function"==typeof e&&e(i)):(M.toast({html:i.responseJSON.error_message}),t.loader=!1)},error:function(e){M.toast({html:e.responseJSON.error_message}),t.loader=!1}})},getData:function(){return{album_id:this.album_id||"",name:this.form.fields.name.value||"",description:this.description||"",status:this.status?1:0,date_publish:this.date_publish,date_create:this.date_create,date_update:this.date_update,album_items:this.items}},getSelectedCategorie(){return this.categories.filter((e,t)=>this.album_id==e.album_id)},serverValidation(e){var t=this,a=BASEURL+"admin/usuarios/ajax_check_field";$.ajax({type:"POST",url:a,data:{field:e,value:t.form.fields[e].value},dataType:"json",success:function(i){t.debug&&console.log(a,i),i.code&&(t.form.fields[e].valid=i.data,i.data?t.form.markFieldAsValid(e):t.form.fields[e].errorText="The "+e+" is already registered",t.$forceUpdate())}})},checkEditMode(){var e=this;if(album_id&&"edit"==editMode){e.editMode=!0;var t=BASEURL+"api/v1/albumes/"+album_id;fetch(t).then(e=>e.json()).then(a=>{e.loader=!1,e.debug&&console.log(t,a),200==a.code&&(e.album_id=a.data.album_id,e.form.fields.name.value=a.data.name,e.date_create=a.data.date_create,e.date_publish=a.data.date_publish,e.date_update=a.data.date_update,e.description=a.data.description,e.status="0"!=a.data.status,e.user_id=a.data.user_id,e.items=a.data.items.map(e=>(e.file=new ExplorerFile(e.file),e)),e.user=new User(a.data.user),setTimeout(()=>{tinymce.editors.id_cazary.setContent(e.description)},5e3)),setTimeout(()=>{M.updateTextFields()},1e3)}).catch(t=>{M.toast({html:t.responseJSON.error_message}),e.loader=!1})}else e.loader=!1},initSelects(){setTimeout(()=>{var e=document.querySelectorAll("select");M.FormSelect.init(e,{})},1e3)},initPlugins(){tinymce.init({selector:"textarea",plugins:["link table code"],setup:e=>{e.on("Change",e=>{this.description=tinymce.editors.id_cazary.getContent()})}})}},mounted:function(){this.$nextTick((function(){this.debug&&console.log("mounted AlbumNewForm"),this.checkEditMode(),this.initPlugins()}))}});